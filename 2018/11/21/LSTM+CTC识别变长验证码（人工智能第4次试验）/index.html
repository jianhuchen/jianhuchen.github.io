<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/32x32.gif?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/16x16.gif?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.5.0',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="1. 实验题目基于RNN——LSTM+CTC的注册码识别实验 2. 实验过程本次实验一共产生了三个文件  generate_verification_code.py：用于产生训练集、验证集、测试集，也就是产生大量验证码 train_model.py：训练模型 predict_test.py：用训练好的模型来识别新输入的验证码  2.1 产生验证码本次实验产生验证码的方法与上次直接使用captcha">
<meta name="keywords" content="科大,人工智能,tensorflow,实验,LSTM,CTC,验证码识别,深度学习">
<meta property="og:type" content="article">
<meta property="og:title" content="LSTM+CTC识别变长验证码（人工智能第4次试验）">
<meta property="og:url" content="http://cjh.zone/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/index.html">
<meta property="og:site_name" content="不想长大的石头">
<meta property="og:description" content="1. 实验题目基于RNN——LSTM+CTC的注册码识别实验 2. 实验过程本次实验一共产生了三个文件  generate_verification_code.py：用于产生训练集、验证集、测试集，也就是产生大量验证码 train_model.py：训练模型 predict_test.py：用训练好的模型来识别新输入的验证码  2.1 产生验证码本次实验产生验证码的方法与上次直接使用captcha">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://cjh.zone/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/data_info.png">
<meta property="og:image" content="http://cjh.zone/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/data_example.png">
<meta property="og:image" content="http://cjh.zone/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/testing_set.png">
<meta property="og:image" content="http://cjh.zone/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/UnicodeErroro.jpg">
<meta property="og:updated_time" content="2018-12-15T04:08:22.393Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LSTM+CTC识别变长验证码（人工智能第4次试验）">
<meta name="twitter:description" content="1. 实验题目基于RNN——LSTM+CTC的注册码识别实验 2. 实验过程本次实验一共产生了三个文件  generate_verification_code.py：用于产生训练集、验证集、测试集，也就是产生大量验证码 train_model.py：训练模型 predict_test.py：用训练好的模型来识别新输入的验证码  2.1 产生验证码本次实验产生验证码的方法与上次直接使用captcha">
<meta name="twitter:image" content="http://cjh.zone/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/data_info.png">






  <link rel="canonical" href="http://cjh.zone/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>LSTM+CTC识别变长验证码（人工智能第4次试验） | 不想长大的石头</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">不想长大的石头</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">Give you my world.</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">19</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-bars"></i> <br>分类<span class="badge">8</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">35</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about_guestbook">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于 & 留言</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-share_resource">

    
    
    
      
    

    
      
    

    <a href="/2018/11/20/共享一些资源" rel="section"><i class="menu-item-icon fa fa-fw fa-cloud-download"></i> <br>共享资源</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-commonweal">

    
    
    
      
    

    
      
    

    <a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>公益 404</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://cjh.zone/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JhChen">
      <meta itemprop="description" content="不想长大的石头">
      <meta itemprop="image" content="/images/100x100.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="不想长大的石头">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">LSTM+CTC识别变长验证码（人工智能第4次试验）
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-11-21 12:45:58" itemprop="dateCreated datePublished" datetime="2018-11-21T12:45:58+08:00">2018-11-21</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-12-15 12:08:22" itemprop="dateModified" datetime="2018-12-15T12:08:22+08:00">2018-12-15</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Artificial-Intelligence/" itemprop="url" rel="index"><span itemprop="name">Artificial Intelligence</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Artificial-Intelligence/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/" class="leancloud_visitors" data-flag-title="LSTM+CTC识别变长验证码（人工智能第4次试验）">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-实验题目"><a href="#1-实验题目" class="headerlink" title="1. 实验题目"></a>1. 实验题目</h1><p><strong>基于RNN——LSTM+CTC的注册码识别实验</strong></p>
<h1 id="2-实验过程"><a href="#2-实验过程" class="headerlink" title="2. 实验过程"></a>2. 实验过程</h1><p>本次实验一共产生了三个文件</p>
<ul>
<li><strong>generate_verification_code.py：</strong>用于产生训练集、验证集、测试集，也就是产生大量验证码</li>
<li><strong>train_model.py</strong>：训练模型</li>
<li><strong>predict_test.py：</strong>用训练好的模型来识别新输入的验证码</li>
</ul>
<h2 id="2-1-产生验证码"><a href="#2-1-产生验证码" class="headerlink" title="2.1 产生验证码"></a>2.1 产生验证码</h2><p>本次实验产生验证码的方法与上次直接使用captcha库产生验证码的实验不同，本次使用的是freetype的方法。</p>
<p><strong>对应文件：generate_verification_code.py：</strong></p>
<h3 id="2-1-1-首先导入所需要的包"><a href="#2-1-1-首先导入所需要的包" class="headerlink" title="2.1.1 首先导入所需要的包"></a>2.1.1 首先导入所需要的包</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> freetype</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li><p>string在产生验证码内容时会用到，用它来控制产生的验证码包含哪些内容，比如数字、大写字母、小写字母</p>
</li>
<li><p>freetype用于对给定的字符产生相应的图片</p>
</li>
<li><p>cv2是opencv在python中包的名字，本次实验为了加大难度，使用freetype产生完一张验证码图片后，可以在这张图片的基础之上再加上高斯噪声，这样能加大实验模型的训练难度</p>
<p>多提一句，当产生的验证码中有噪声时，同样也可以使用opencv的均值模糊、高斯模糊等方法来降低噪声，总之，opencv是一个非常强大的计算机视觉库，它能对图片加噪，也能去噪</p>
</li>
<li><p>random库用于产生随机数，因为本实验要求验证码的长度是不确定的</p>
</li>
</ul>
<h3 id="2-1-2-定义put-chinese-text类"><a href="#2-1-2-定义put-chinese-text类" class="headerlink" title="2.1.2 定义put_chinese_text类"></a>2.1.2 定义put_chinese_text类</h3><p><strong>put_chinese_text类</strong>用于将某一个串字符“画”到图上去</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">put_chinese_text</span><span class="params">(object)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, ttf)</span>:</span></span><br><span class="line">		self._face = freetype.Face(ttf)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">draw_text</span><span class="params">(self, image, pos, text, text_size, text_color)</span>:</span></span><br><span class="line">		self._face.set_char_size(text_size * <span class="number">64</span>)</span><br><span class="line">		metrics = self._face.size</span><br><span class="line">		ascender = metrics.ascender/<span class="number">64.0</span></span><br><span class="line"></span><br><span class="line">		ypos = int(ascender)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> isinstance(text, str):</span><br><span class="line">			text = text.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">		img = self.draw_string(image, pos[<span class="number">0</span>], pos[<span class="number">1</span>]+ypos, text, text_color)</span><br><span class="line">		<span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">draw_string</span><span class="params">(self, img, x_pos, y_pos, text, color)</span>:</span></span><br><span class="line">		prev_char = <span class="number">0</span></span><br><span class="line">		pen = freetype.Vector()</span><br><span class="line">		pen.x = x_pos &lt;&lt; <span class="number">6</span>   <span class="comment"># div 64</span></span><br><span class="line">		pen.y = y_pos &lt;&lt; <span class="number">6</span></span><br><span class="line"></span><br><span class="line">		hscale = <span class="number">1.0</span></span><br><span class="line">		matrix = freetype.Matrix(int(hscale)*<span class="number">0x10000</span>, int(<span class="number">0.2</span>*<span class="number">0x10000</span>),\</span><br><span class="line">								 int(<span class="number">0.0</span>*<span class="number">0x10000</span>), int(<span class="number">1.1</span>*<span class="number">0x10000</span>))</span><br><span class="line">		cur_pen = freetype.Vector()</span><br><span class="line">		pen_translate = freetype.Vector()</span><br><span class="line"></span><br><span class="line">		image = copy.deepcopy(img)</span><br><span class="line">		<span class="keyword">for</span> cur_char <span class="keyword">in</span> text:</span><br><span class="line">			self._face.set_transform(matrix, pen_translate)</span><br><span class="line"></span><br><span class="line">			self._face.load_char(cur_char)</span><br><span class="line">			kerning = self._face.get_kerning(prev_char, cur_char)</span><br><span class="line">			pen.x += kerning.x</span><br><span class="line">			slot = self._face.glyph</span><br><span class="line">			bitmap = slot.bitmap</span><br><span class="line"></span><br><span class="line">			cur_pen.x = pen.x</span><br><span class="line">			cur_pen.y = pen.y - slot.bitmap_top * <span class="number">64</span></span><br><span class="line">			self.draw_ft_bitmap(image, bitmap, cur_pen, color)</span><br><span class="line"></span><br><span class="line">			pen.x += slot.advance.x</span><br><span class="line">			prev_char = cur_char</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">draw_ft_bitmap</span><span class="params">(self, img, bitmap, pen, color)</span>:</span></span><br><span class="line">		x_pos = pen.x &gt;&gt; <span class="number">6</span></span><br><span class="line">		y_pos = pen.y &gt;&gt; <span class="number">6</span></span><br><span class="line">		cols = bitmap.width</span><br><span class="line">		rows = bitmap.rows</span><br><span class="line"></span><br><span class="line">		glyph_pixels = bitmap.buffer</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> row <span class="keyword">in</span> range(rows):</span><br><span class="line">			<span class="keyword">for</span> col <span class="keyword">in</span> range(cols):</span><br><span class="line">				<span class="keyword">if</span> glyph_pixels[row*cols + col] != <span class="number">0</span>:</span><br><span class="line">					img[y_pos + row][x_pos + col][<span class="number">0</span>] = color[<span class="number">0</span>]</span><br><span class="line">					img[y_pos + row][x_pos + col][<span class="number">1</span>] = color[<span class="number">1</span>]</span><br><span class="line">					img[y_pos + row][x_pos + col][<span class="number">2</span>] = color[<span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<h3 id="2-1-3-定义generateVerificationCode类"><a href="#2-1-3-定义generateVerificationCode类" class="headerlink" title="2.1.3 定义generateVerificationCode类"></a>2.1.3 定义generateVerificationCode类</h3><p><strong>generateVerificationCode类</strong>用于产生验证码，具体代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">generateVerificationCode</span><span class="params">(object)</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,</span></span></span><br><span class="line"><span class="function"><span class="params">					width=<span class="number">256</span>, # 验证码图片的宽</span></span></span><br><span class="line"><span class="function"><span class="params">					height=<span class="number">32</span>, # 验证码图片的高</span></span></span><br><span class="line"><span class="function"><span class="params">					char_max_size=<span class="number">5</span>, # 验证码最多的字符个数</span></span></span><br><span class="line"><span class="function"><span class="params">					characters=string.digits)</span>:</span><span class="comment"># + string.ascii_uppercase + string.ascii_lowercase):#验证码组成，数字+大写字母+小写字母</span></span><br><span class="line">		self.width = width</span><br><span class="line">		self.height = height</span><br><span class="line">		self.char_max_size = char_max_size</span><br><span class="line">		self.characters = characters</span><br><span class="line">		self.classes = len(characters) <span class="comment"># 一共有多少类</span></span><br><span class="line">		self.char_set = list(self.characters)</span><br><span class="line">		self.ft = put_chinese_text(<span class="string">'fonts/OCR-B.ttf'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">gen_verification_code</span><span class="params">(self, is_random=False, batch_size=<span class="number">50</span>)</span>:</span></span><br><span class="line">		X = np.zeros([batch_size, self.height, self.width, <span class="number">3</span>]) <span class="comment"># 3个通道</span></span><br><span class="line">		Y = np.zeros([batch_size, self.char_max_size, self.classes]) <span class="comment"># one_hot编码</span></span><br><span class="line">		text_list=[]</span><br><span class="line">		<span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">			<span class="keyword">for</span> i <span class="keyword">in</span> range(batch_size):</span><br><span class="line">				<span class="comment"># 随机设定长度</span></span><br><span class="line">				<span class="keyword">if</span> is_random == <span class="keyword">True</span>:</span><br><span class="line">					size = random.randint(<span class="number">1</span>, self.char_max_size)</span><br><span class="line">				<span class="keyword">else</span>:</span><br><span class="line">					size = self.char_max_size</span><br><span class="line">				<span class="comment"># 产生size长度的随机串</span></span><br><span class="line">				text = <span class="string">''</span>.join(random.sample(self.characters, size))</span><br><span class="line">				<span class="comment"># 保存所有str类型的label</span></span><br><span class="line">				text_list.append(list(text))</span><br><span class="line">				<span class="comment"># 产生一张图片</span></span><br><span class="line">				img = np.zeros([self.height, self.width, <span class="number">3</span>]) <span class="comment"># 三个通道</span></span><br><span class="line">				color_ = (<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>) <span class="comment"># Write</span></span><br><span class="line">				pos = (<span class="number">0</span>, <span class="number">3</span>)</span><br><span class="line">				text_size = <span class="number">25</span></span><br><span class="line">				image = self.ft.draw_text(img, pos, text, text_size, color_)</span><br><span class="line">				X[i] = np.reshape(image, [self.height, self.width, <span class="number">3</span>]) <span class="comment"># /255.0  # 将数据全部变换到 [0,1] 范围内</span></span><br><span class="line">				<span class="keyword">for</span> j, ch <span class="keyword">in</span> enumerate(text):</span><br><span class="line">					Y[i, j, self.characters.find(ch)] = <span class="number">1</span></span><br><span class="line">				<span class="comment"># print("X.shape = ", X.shape)</span></span><br><span class="line">				<span class="comment"># print(X)</span></span><br><span class="line">				<span class="comment"># print("text_list = ", text_list)</span></span><br><span class="line">				<span class="comment"># print("Y.shape = ", Y.shape)</span></span><br><span class="line">				<span class="comment"># print(Y)</span></span><br><span class="line">			<span class="keyword">yield</span> X, text_list, Y</span><br></pre></td></tr></table></figure>
<p><strong>首先看<code>__init__()</code>函数，它一共有5个参数，分别如下：</strong></p>
<ul>
<li>width：设置产生的验证码图片的宽</li>
<li>height：设置产生的验证码图片的高</li>
<li>char_max_size：设置产生的验证码最多的字符个数， 我这里为了训练速度快一些设成了5</li>
<li>characters：设置验证码中字符串的组成，我的代码中设置只产生了数字，可以讲它改为<code>string.digits + string.ascii_uppercase + string.ascii_lowercase</code>，这样就可以产生数字、大写字母、小写字母混合的验证码</li>
</ul>
<p><strong>再看<code>gen_verification_code()</code>函数，它一共有3各参数，分别如下：</strong></p>
<ul>
<li>is_random：设置验证码的长度是否随机，默认是<code>False</code>，此时产生的验证码为定长验证码，长度为<code>char_max_size</code></li>
<li>batch_size：设置一次产生验证码的张数，例如产生一个batch的训练集时，可以用于指定batch_size</li>
</ul>
<p>需要特别说明的是，第31行代码使用numpy产生一个shape为[height, width, 3]的矩阵，相当于是生成一张图片，但图片上什么信息都没有，待会调用<code>put_chinese_text</code>类中的方法来将随机字符串<code>text</code>中的内容“画”上去</p>
<p><code>color_</code>变量用于设置“画”验证码时验证码上的字符颜色，我这里设置成白色了，<code>pos</code>标量用于设置“画”验证码的起点，<code>text_size</code>用于设置验证码中字符的字体大小</p>
<p>参数设置好后，再调用<code>put_chinese_text</code>类中的<code>draw_text()</code>方法来“画”验证码，画好之后的图赋值给<code>image</code>变量</p>
<p><code>gen_verification_code()</code>函数最后返回的变量一共三个，分别如下：</p>
<ul>
<li>X：shape=[batch_size, width, height]，产生的验证码的矩阵形式</li>
<li>text_list：一个长度为batch_size的列表，每个元素对应每张图片上的字符串</li>
<li>Y：它与text_list的意义相同，只是形式不同，它是text_list的<code>one-hot</code>编码形式</li>
</ul>
<p><strong>最后，来测试一下函数的执行情况</strong></p>
<p>为了方便查看，我将<code>batch_size</code>设为3，将上面代码的39-43行的打印信息代码的注释打开，再执行下方的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	genObj = generateVerificationCode()</span><br><span class="line">	X, codes, Y = next(genObj.gen_verification_code(is_random=<span class="keyword">True</span>, batch_size=<span class="number">3</span>))</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">		cv2.imshow(str(codes[i]), X[i])</span><br><span class="line">	cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>代码中的4-5行使用opencv显示了验证码的图像</p>
<p>结果如下：</p>
<p><img src=".\data_info.png" width="700px" title="data_info"></p>
<p><img src=".\data_example.png" width="300px" title="data_example"></p>
<p>除此之外，我还定义了一个生成测试集的<code>gen_test_verification_code()</code>函数，它能够方便的生成100（默认）张图片，保存在你指定的目录<code>dir</code>下，在做测试的时候可以使用opencv库读入他们并导入训练好的模型来做测试，后面测试模型时会用到，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen_test_verification_code</span><span class="params">(self, dir, is_random=False, num=<span class="number">100</span>)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(dir):</span><br><span class="line">		os.makedirs(dir)</span><br><span class="line">	X = np.zeros([self.height, self.width, <span class="number">3</span>]) <span class="comment"># 3个通道</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(num):</span><br><span class="line">		<span class="comment"># 随机设定长度</span></span><br><span class="line">		<span class="keyword">if</span> is_random == <span class="keyword">True</span>:</span><br><span class="line">			size = random.randint(<span class="number">1</span>, self.char_max_size)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			size = self.char_max_size</span><br><span class="line">		<span class="comment"># 产生size长度的随机串</span></span><br><span class="line">		text = <span class="string">''</span>.join(random.sample(self.characters, size))</span><br><span class="line">		<span class="comment"># 产生一张图片</span></span><br><span class="line">		img = np.zeros([self.height, self.width, <span class="number">3</span>]) <span class="comment"># 三个通道</span></span><br><span class="line">		color_ = (<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>) <span class="comment"># Write</span></span><br><span class="line">		pos = (<span class="number">0</span>, <span class="number">3</span>)</span><br><span class="line">		text_size = <span class="number">25</span></span><br><span class="line">		image = self.ft.draw_text(img, pos, text, text_size, color_)</span><br><span class="line">		X = np.reshape(image, [self.height, self.width, <span class="number">3</span>]) <span class="comment"># /255.0  # 将数据全部变换到 [0,1] 范围内</span></span><br><span class="line">		cv2.imwrite(dir+<span class="string">'/'</span>+text+<span class="string">'.png'</span>, X[:, :, <span class="number">2</span>])</span><br><span class="line">		print(<span class="string">"\rGenerating.........(%d/%d)"</span>%(i+<span class="number">1</span>, num), end=<span class="string">''</span>)	</span><br><span class="line">	print(<span class="string">"\nTest verification code generated........."</span>)</span><br></pre></td></tr></table></figure>
<h2 id="2-2-训练模型"><a href="#2-2-训练模型" class="headerlink" title="2.2 训练模型"></a>2.2 训练模型</h2><p>本次实验采用的网络结构为RNN（循环神经网络）中的LSTM（长短时记忆网络），采用CTC（联结主义时间分类器 ，Connectionist Temporal Classifier）作为损失函数，它适合于输入特征和输出标签之间对齐关系不确定的时间序列问题，CTC可以自动端到端地同时优化模型参数和对齐切分的边界。</p>
<p><strong>对应文件：train_model.py</strong></p>
<p>首先导入相关的包</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> generate_verification_code <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> time </span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br></pre></td></tr></table></figure>
<h3 id="2-2-1-定义一些超参数"><a href="#2-2-1-定义一些超参数" class="headerlink" title="2.2.1 定义一些超参数"></a>2.2.1 定义一些超参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#图片大小，32 x 256</span></span><br><span class="line">OUTPUT_SHAPE = (<span class="number">32</span>,<span class="number">256</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># LSTM 循环体个数=64  层数=1</span></span><br><span class="line">num_hidden = <span class="number">64</span></span><br><span class="line">num_layers = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">obj = generateVerificationCode()</span><br><span class="line">num_classes = obj.classes + <span class="number">1</span> + <span class="number">1</span>  <span class="comment"># 10位数字 + blank + ctc blank</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#训练最大轮次</span></span><br><span class="line">num_epochs = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化学习速率</span></span><br><span class="line">INITIAL_LEARNING_RATE = <span class="number">1e-3</span></span><br><span class="line">DECAY_STEPS = <span class="number">5000</span></span><br><span class="line">REPORT_STEPS = <span class="number">100</span></span><br><span class="line">LEARNING_RATE_DECAY_FACTOR = <span class="number">0.9</span>  <span class="comment"># The learning rate decay factor</span></span><br><span class="line"></span><br><span class="line">DIGITS=<span class="string">'0123456789'</span></span><br><span class="line">BATCHES = <span class="number">10</span></span><br><span class="line">BATCH_SIZE = <span class="number">64</span> </span><br><span class="line">TRAIN_SIZE = BATCHES * BATCH_SIZE</span><br></pre></td></tr></table></figure>
<p>这些超参数在后面用到的时候会陆陆续续提到，这里就不过多解释了，把它放在这里写是因为这些超参数一般都放在文件的头部</p>
<h3 id="2-2-2-关于ctc-loss"><a href="#2-2-2-关于ctc-loss" class="headerlink" title="2.2.2 关于ctc_loss"></a>2.2.2 关于ctc_loss</h3><p>上面提到了我们的损失函数是<code>ctc_loss</code>，它在<a href="https://www.tensorflow.org/api_docs/python/tf/nn/ctc_loss" target="_blank" rel="noopener">tensorflow中的定义</a>如下： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tf.nn.ctc_loss(</span><br><span class="line">    labels,</span><br><span class="line">    inputs,</span><br><span class="line">    sequence_length,</span><br><span class="line">    preprocess_collapse_repeated=<span class="keyword">False</span>,</span><br><span class="line">    ctc_merge_repeated=<span class="keyword">True</span>,</span><br><span class="line">    ignore_longer_outputs_than_inputs=<span class="keyword">False</span>,</span><br><span class="line">    time_major=<span class="keyword">True</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>labels</strong>: An <code>int32</code> <code>SparseTensor</code>，用来传入你训练数据的真实值，要求是int32类型的<strong>稀疏矩阵</strong>。</p>
<blockquote>
<p> 稀疏矩阵：在<strong>矩阵</strong>中，若数值为0的元素数目远远多于非0元素的数目，并且非0元素分布没有规律时，则称该<strong>矩阵</strong>为<strong>稀疏矩阵</strong>；与之相反，若非0元素数目占大多数时，则称该<strong>矩阵</strong>为稠密<strong>矩阵</strong>。（百度百科）</p>
<p>一个稀疏矩阵由三个要素要确定：</p>
<ul>
<li><code>indices</code>:二维int64的矩阵，代表非0的坐标点</li>
<li><code>values</code>:二维tensor，代表indice位置的数据值</li>
<li><code>dense_shape</code>:一维，代表稀疏矩阵的大小</li>
</ul>
<p>举例：</p>
<p>拿上面产生的三张验证码的字符串’196’、‘76924’和‘58407’来举例，他们的<code>dense tensor</code>形式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; [[<span class="number">1</span>,<span class="number">9</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>]</span><br><span class="line">&gt;  [<span class="number">7</span>,<span class="number">6</span>,<span class="number">9</span>,<span class="number">2</span>,<span class="number">4</span>]</span><br><span class="line">&gt;  [<span class="number">5</span>,<span class="number">8</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">7</span>]]</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>把他们转换成系数矩阵的形式就像这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; indecs = [[<span class="number">0</span>,<span class="number">0</span>],[<span class="number">0</span>,<span class="number">1</span>],[<span class="number">0</span>,<span class="number">2</span>],[<span class="number">1</span>,<span class="number">0</span>],[<span class="number">1</span>,<span class="number">1</span>],[<span class="number">1</span>,<span class="number">2</span>],[<span class="number">1</span>,<span class="number">3</span>],[<span class="number">1</span>,<span class="number">4</span>],[<span class="number">2</span>,<span class="number">0</span>],[<span class="number">2</span>,<span class="number">1</span>],[<span class="number">2</span>,<span class="number">2</span>],[<span class="number">2</span>,<span class="number">3</span>],[<span class="number">2</span>,<span class="number">4</span>]]</span><br><span class="line">&gt; values = [<span class="number">1</span>,<span class="number">9</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">9</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">8</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">7</span>]</span><br><span class="line">&gt; dense_shape = [<span class="number">3</span>,<span class="number">5</span>]</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p><strong>inputs</strong>: 3-D <code>float</code> <code>Tensor</code>，用来传入你模型预测出的结果，要求是一个三维float型的数据结构</p>
<ul>
<li><p>如果 <strong><code>time_major = False</code></strong>，<strong>inputs</strong>要求的形状为: <code>[batch_size, max_time, num_classes]</code>.</p>
</li>
<li><p>如果 <strong><code>time_major = True (默认)</code></strong>，<strong>inputs</strong>要求的形状为: <code>[max_time, batch_size, num_classes]</code>.</p>
</li>
</ul>
</li>
<li><p><strong>sequence_length</strong>: 1-D <code>int32</code> vector, size <code>[batch_size]</code>.它表示一个batch中每个输入LSTM网络的数据的序列的长度，例如本实验中都是256</p>
<p>格式要求：一维int32类型的向量，内容为[seq_len,…,seq_len]，长度为batch_size</p>
</li>
</ul>
<p><strong>了解完ctc_loss之后，发现需要做如下工作：</strong></p>
<ul>
<li><p><strong>稀疏矩阵的编码</strong></p>
<p>我们之前使用<strong>generateVerificationCode类</strong>中用<strong>gen_verification_code()函数</strong>产生的数据集，它的返回值中<code>text_list</code>是<code>序列列表</code>的形式，并不是<code>SparseTensor</code>的形式，所以我们需要有函数来将它转换成<code>SparseTensor</code>形式，代码如下：</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#转化一个序列列表为稀疏矩阵    </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sparse_tuple_from</span><span class="params">(sequences, dtype=np.int32)</span>:</span></span><br><span class="line">	indices = []</span><br><span class="line">	values = []</span><br><span class="line">	<span class="keyword">for</span> n, seq <span class="keyword">in</span> enumerate(sequences):</span><br><span class="line">		indices.extend(zip([n] * len(seq), range(len(seq))))</span><br><span class="line">		values.extend(seq)</span><br><span class="line">	indices = np.asarray(indices, dtype=np.int64)</span><br><span class="line">	values = np.asarray(values, dtype=dtype)</span><br><span class="line">	shape = np.asarray([len(sequences), np.asarray(indices).max(<span class="number">0</span>)[<span class="number">1</span>] + <span class="number">1</span>], dtype=np.int64)</span><br><span class="line">	<span class="keyword">return</span> indices, values, shape</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>系数矩阵的解码</strong></p>
<p><code>SparseTensor</code>形式的数据是<code>ctc_loss</code>的要求，讲预测值与真实值送进<code>ctc_loss</code>做损失计算，但是最后我们在测试阶段需要看预测的数据对不对，这时需要将<code>SparseTensor</code>形式的数据转换回去（序列列表），代码如下：</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_sparse_tensor</span><span class="params">(sparse_tensor)</span>:</span></span><br><span class="line">	decoded_indexes = list()</span><br><span class="line">	current_i = <span class="number">0</span></span><br><span class="line">	current_seq = []</span><br><span class="line">	<span class="keyword">for</span> offset, i_and_index <span class="keyword">in</span> enumerate(sparse_tensor[<span class="number">0</span>]):</span><br><span class="line">		i = i_and_index[<span class="number">0</span>]</span><br><span class="line">		<span class="keyword">if</span> i != current_i:</span><br><span class="line">			decoded_indexes.append(current_seq)</span><br><span class="line">			current_i = i</span><br><span class="line">			current_seq = list()</span><br><span class="line">		current_seq.append(offset)</span><br><span class="line">	decoded_indexes.append(current_seq)</span><br><span class="line">	result = []</span><br><span class="line">	<span class="keyword">for</span> index <span class="keyword">in</span> decoded_indexes:</span><br><span class="line">		result.append(decode_a_seq(index, sparse_tensor))</span><br><span class="line">	<span class="keyword">return</span> result</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_a_seq</span><span class="params">(indexes, spars_tensor)</span>:</span></span><br><span class="line">	decoded = []</span><br><span class="line">	<span class="keyword">for</span> m <span class="keyword">in</span> indexes:</span><br><span class="line">		str = DIGITS[spars_tensor[<span class="number">1</span>][m]]</span><br><span class="line">		decoded.append(str)</span><br><span class="line">	<span class="keyword">return</span> decoded</span><br></pre></td></tr></table></figure>
<h3 id="2-2-3-训练数据集的生成"><a href="#2-2-3-训练数据集的生成" class="headerlink" title="2.2.3 训练数据集的生成"></a>2.2.3 训练数据集的生成</h3><p>前面已经有生成验证码的函数了，为什么这里还要写生成训练数据集的函数呢?</p>
<p>原因前面已经讨论到了，即使用<strong><code>generateVerificationCode类</code></strong>中用<strong><code>gen_verification_code()函数</code></strong>产生的数据集的<code>label</code>（标签）并不符合<code>ctc_loss</code>的格式要求，上面也只是定义了可以将<code>序列列表</code>的形式的标签转换成<code>SparseTensor</code>的形式标签的函数，还没有调用，现在做的工作是调用上面的函数来生成数据格式符合<code>ctc_loss</code>要求的训练集，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成一个训练batch</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_next_batch</span><span class="params">(batch_size=<span class="number">128</span>, is_random=True)</span>:</span></span><br><span class="line">	obj = generateVerificationCode()</span><br><span class="line">	<span class="comment"># X.shape=[batch_size, height, width, 3]</span></span><br><span class="line">	<span class="comment"># 获取一个batch的数据集</span></span><br><span class="line">	<span class="comment"># codes为一个列表，所有str类型的label</span></span><br><span class="line">	X, text_list, Y = next(obj.gen_verification_code(is_random=is_random, batch_size=batch_size))</span><br><span class="line">	<span class="comment"># 这一步的作用：改变形状[batch_size, height, width, 1]=&gt;[batch_size, height, width]=&gt;[batch_size, width, height]</span></span><br><span class="line">	X = np.transpose(np.reshape(X[:,:,:,<span class="number">2</span>], [batch_size,OUTPUT_SHAPE[<span class="number">0</span>],OUTPUT_SHAPE[<span class="number">1</span>]]), (<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>))</span><br><span class="line">	<span class="comment">#targets转成稀疏矩阵 </span></span><br><span class="line">	<span class="comment"># 返回三个值，非零元素的位置信息，非零元素对应的值，稀疏矩阵的形状</span></span><br><span class="line">	sparse_targets = sparse_tuple_from(text_list)</span><br><span class="line">	<span class="comment">#(batch_size,) sequence_length值都是256，最大划分列数</span></span><br><span class="line">	seq_len = np.ones(X.shape[<span class="number">0</span>]) * OUTPUT_SHAPE[<span class="number">1</span>]</span><br><span class="line">	<span class="keyword">return</span> X, sparse_targets, seq_len</span><br></pre></td></tr></table></figure>
<p>这个函数的第9行将验证码的颜色变成了单通道，原因也是我希望训练速度能快一些</p>
<p>函数里面涉及到了很多数据格式的转换，在本实验中的总体的数据流如下：</p>
<blockquote>
<p>gen_verification_code()—-&gt;[batch_size, seq_len, num_features]</p>
<p>—-&gt;LSTM—-&gt;[batch_size, seq_len, cell.output_size]—-&gt;reshape</p>
<p>—-&gt;[batch_size*seq_len, num_hidden]—-&gt;affine projection A*W+b</p>
<p>—-&gt;[batch_size*seq_len, num_classes]—-&gt;reshape</p>
<p>—-&gt;[batch_size, seq_len, num_classes]—-&gt;transpose</p>
<p>—-&gt;[seq_len, batch_size, num_classes]</p>
</blockquote>
<p>至于为什么要做这么繁琐的数据转换，下面马上要提到啦</p>
<h3 id="2-2-4-定义LSTM网络模型"><a href="#2-2-4-定义LSTM网络模型" class="headerlink" title="2.2.4 定义LSTM网络模型"></a>2.2.4 定义LSTM网络模型</h3><p>整体的网络结构是：输入单元—&gt;64个隐藏单元（循环体）—&gt;12个输出单元</p>
<p>所以在第10行将得到的LSTM输出值reshape成<code>[batch_size\*seq_len, num_hidden]</code>之后，又继续将他们连接到了输出层的12个神经元，最终返回的logits是reshape成<code>[seq_len, batch_size, num_classes]</code>之后的数据</p>
<p><strong>为什么要这样一直reshape？</strong></p>
<p>因为这个返回的logis即将要作为<code>inputs</code>数据被喂送到<code>ctc_loss</code>里面啦，上面已经写到了<code>ctc_loss</code>的<code>inputs</code>需要<code>[max_time, batch_size, num_classes]</code>这样的数据格式</p>
<p><strong>涉及到的超参数：</strong></p>
<ul>
<li>num_hidden = 64</li>
<li>num_layers = 1</li>
</ul>
<p>所以这个LSTM网络中间循环体的个数是64个，层数是1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RNN</span><span class="params">(inputs, seq_len)</span>:</span></span><br><span class="line">	<span class="comment">#定义LSTM网络</span></span><br><span class="line">	cell = tf.contrib.rnn.LSTMCell(num_hidden, state_is_tuple=<span class="keyword">True</span>)</span><br><span class="line">	stack = tf.contrib.rnn.MultiRNNCell([cell] * num_layers, state_is_tuple=<span class="keyword">True</span>)</span><br><span class="line">	<span class="comment">#output的shape=(64,256,64)(batch_size*256条*64个output)[batch_size,seq_len,cell.output_size]</span></span><br><span class="line">	outputs, _ = tf.nn.dynamic_rnn(cell, inputs, seq_len, dtype=tf.float32)</span><br><span class="line">	shape = tf.shape(inputs)</span><br><span class="line">	batch_s, max_timesteps = shape[<span class="number">0</span>], shape[<span class="number">1</span>]</span><br><span class="line">	<span class="comment"># 为方便矩阵运算，reshape一下outputs，outputs的size是(64*256,64)</span></span><br><span class="line">	outputs = tf.reshape(outputs, [<span class="number">-1</span>, num_hidden])</span><br><span class="line">	<span class="comment"># 初始化权值  生成一个截断的正态分布</span></span><br><span class="line">	weights = tf.Variable(tf.truncated_normal([num_hidden, num_classes], stddev=<span class="number">0.1</span>), name=<span class="string">"W"</span>)</span><br><span class="line">	bias = tf.Variable(tf.constant(<span class="number">0.</span>, shape=[num_classes]), name=<span class="string">"b"</span>)</span><br><span class="line">	<span class="comment"># 计算结果</span></span><br><span class="line">	<span class="comment"># result形状：[64*256, 12]</span></span><br><span class="line">	logits = tf.matmul(outputs, weights) + bias</span><br><span class="line">	<span class="comment"># reshape之后logits的shape是(64,256,12) [batch_size,seq_len,num_classes]</span></span><br><span class="line">	logits = tf.reshape(logits, [tf.shape(inputs)[<span class="number">0</span>], <span class="number">-1</span>, num_classes])</span><br><span class="line">	<span class="comment">#交换坐标轴，axis0和axis1互换，logits的shape是(256,64,12) [seq_len,batch_size,num_classes]</span></span><br><span class="line">	logits = tf.transpose(logits, (<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>))</span><br><span class="line">	<span class="keyword">return</span> logits</span><br></pre></td></tr></table></figure>
<h3 id="2-2-5-开始训练"><a href="#2-2-5-开始训练" class="headerlink" title="2.2.5 开始训练"></a>2.2.5 开始训练</h3><p>在开始训练之前，先定义一个函数来检测待会儿模型预测结果的正确率，并且打印出预测的结果和真实的label</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_report</span><span class="params">()</span>:</span></span><br><span class="line">	test_inputs,test_targets,test_seq_len = get_next_batch(BATCH_SIZE)</span><br><span class="line">	test_feed = &#123;inputs: test_inputs, targets: test_targets, seq_len: test_seq_len&#125;</span><br><span class="line">	decoded_list, log_probs, accuracy = session.run([decoded[<span class="number">0</span>], log_prob, acc], test_feed)</span><br><span class="line">	</span><br><span class="line">	original_list = decode_sparse_tensor(test_targets)</span><br><span class="line">	detected_list = decode_sparse_tensor(decoded_list)</span><br><span class="line"></span><br><span class="line">	true_numer = <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> len(original_list) != len(detected_list):</span><br><span class="line">		print(<span class="string">"len(original_list)"</span>, len(original_list), <span class="string">"len(detected_list)"</span>, len(detected_list),</span><br><span class="line">			  <span class="string">" test and detect length desn't match"</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">	print(<span class="string">"T/F: original(length) &lt;-------&gt; detectcted(length)"</span>)</span><br><span class="line">	<span class="keyword">for</span> idx, number <span class="keyword">in</span> enumerate(original_list):</span><br><span class="line">		detect_number = detected_list[idx]</span><br><span class="line">		hit = (number == detect_number)</span><br><span class="line">		print(hit, number, <span class="string">"("</span>, len(number), <span class="string">") &lt;-------&gt; "</span>, detect_number, <span class="string">"("</span>, len(detect_number), <span class="string">")"</span>)</span><br><span class="line">		<span class="keyword">if</span> hit:</span><br><span class="line">			true_numer = true_numer + <span class="number">1</span></span><br><span class="line">	Accuracy = true_numer * <span class="number">1.0</span> / len(original_list)</span><br><span class="line">	print(<span class="string">"Test Accuracy:"</span>, Accuracy)</span><br><span class="line">	<span class="keyword">return</span> Accuracy</span><br></pre></td></tr></table></figure>
<p>接下来看开始写训练的代码</p>
<p><strong>涉及到的超参数：</strong></p>
<ul>
<li>epoch：训练的轮数，由前面的<code>num_epochs = 10000</code>控制，表示最多训练10000轮</li>
<li>BATCHES：表示一轮训练里batch的数量，本实验中我设置的是10</li>
<li>BATCH_SIZE：表示每个batch中的验证码个数</li>
<li>TRAIN_SIZE：表示一个epoch训练下来，一共使用了多少张验证码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	<span class="comment"># 用来记录全局step，每更新一次参数就会+1</span></span><br><span class="line">	global_step = tf.Variable(<span class="number">0</span>, trainable=<span class="keyword">False</span>)</span><br><span class="line">	inputs = tf.placeholder(tf.float32, [<span class="keyword">None</span>, OUTPUT_SHAPE[<span class="number">1</span>], OUTPUT_SHAPE[<span class="number">0</span>]])</span><br><span class="line">	<span class="comment">#targets是标签(稀疏矩阵的形式)，因为定义ctc_loss需要的稀疏矩阵</span></span><br><span class="line">	targets = tf.sparse_placeholder(tf.int32)</span><br><span class="line">	<span class="comment">#1维向量 序列长度 [batch_size,]</span></span><br><span class="line">	<span class="comment">#是一个长度=BATCH_SIZE=64的一维向量,每个里面都是256，表示一个batch中每一张有256条输入序列  </span></span><br><span class="line">	seq_len = tf.placeholder(tf.int32, [<span class="keyword">None</span>])</span><br><span class="line">	<span class="comment"># 定义指数下降的学习率</span></span><br><span class="line">	learning_rate = tf.train.exponential_decay(INITIAL_LEARNING_RATE, global_step, DECAY_STEPS, LEARNING_RATE_DECAY_FACTOR, staircase=<span class="keyword">True</span>)</span><br><span class="line">	<span class="comment"># 调用前面定义好的模型，并传入值</span></span><br><span class="line">	logits = RNN(inputs, seq_len)</span><br><span class="line">	<span class="comment"># 定义CTC损失函数 需要喂入数据：targets，logits，seq_len</span></span><br><span class="line">	cost = tf.reduce_mean(tf.nn.ctc_loss(labels=targets, inputs=logits, sequence_length=seq_len))</span><br><span class="line">	<span class="comment"># 使用AdamOptimizer进行优化</span></span><br><span class="line">	optimizer = tf.train.AdamOptimizer(learning_rate=learning_rate).minimize(cost, global_step=global_step)</span><br><span class="line">	<span class="comment"># 解码，获得结果</span></span><br><span class="line">	decoded, log_prob = tf.nn.ctc_beam_search_decoder(logits, seq_len, merge_repeated=<span class="keyword">False</span>)</span><br><span class="line">	<span class="comment"># 求准确率</span></span><br><span class="line">	acc = tf.reduce_mean(tf.edit_distance(tf.cast(decoded[<span class="number">0</span>], tf.int32), targets))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">with</span> tf.Session() <span class="keyword">as</span> session:</span><br><span class="line">		session.run(tf.global_variables_initializer())</span><br><span class="line">		<span class="comment"># 载入模型</span></span><br><span class="line">		saver = tf.train.Saver(tf.global_variables(), max_to_keep=<span class="number">3</span>)</span><br><span class="line">		ckpt_dir = <span class="string">"./ckpt_dir"</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(ckpt_dir):</span><br><span class="line">			os.makedirs(ckpt_dir)</span><br><span class="line">		ckpt = tf.train.get_checkpoint_state(ckpt_dir)</span><br><span class="line">		<span class="keyword">if</span> ckpt <span class="keyword">and</span> ckpt.model_checkpoint_path:</span><br><span class="line">			saver.restore(session, ckpt.model_checkpoint_path)</span><br><span class="line">			print(<span class="string">"Restore succcess! path:"</span>, ckpt.model_checkpoint_path)</span><br><span class="line"></span><br><span class="line">		<span class="comment"># 开始训练</span></span><br><span class="line">		<span class="comment"># 定义训练结束的标志，当正确率达到某一值时，可以通过设置它来提前结束训练</span></span><br><span class="line">		train_end_flag = <span class="keyword">False</span></span><br><span class="line">		start_time = time.time() <span class="comment"># 记录时间</span></span><br><span class="line">		<span class="keyword">for</span> curr_epoch <span class="keyword">in</span> range(num_epochs):</span><br><span class="line">			print(<span class="string">"Epoch......."</span>, curr_epoch)</span><br><span class="line">			train_cost =  <span class="number">0</span></span><br><span class="line">			<span class="keyword">for</span> batch <span class="keyword">in</span> range(BATCHES):</span><br><span class="line">				b_start_time = time.time()</span><br><span class="line">				<span class="comment"># 产生mini-batch=64的训练集数据</span></span><br><span class="line">				train_inputs, train_targets, train_seq_len = get_next_batch(BATCH_SIZE)</span><br><span class="line">				feed = &#123;inputs: train_inputs, targets: train_targets, seq_len: train_seq_len&#125;</span><br><span class="line">				train_acc, _, b_cost, steps,  = session.run([acc, optimizer, cost, global_step], feed)</span><br><span class="line">				train_cost += b_cost</span><br><span class="line">				print(<span class="string">"Step:"</span>, steps, <span class="string">", batch_time:"</span>, time.time()-b_start_time, <span class="string">'s'</span>)</span><br><span class="line">				<span class="comment"># 每REPORT_STEPS个step测试一下正确率，并打印预测结果和真实label</span></span><br><span class="line">				<span class="keyword">if</span> steps &gt; <span class="number">0</span> <span class="keyword">and</span> steps % REPORT_STEPS == <span class="number">0</span>:</span><br><span class="line">					<span class="keyword">if</span>(do_report()&gt;<span class="number">0.9</span>):</span><br><span class="line">						save_path = saver.save(session, ckpt_dir+<span class="string">"/model.ckpt"</span>, global_step=steps)</span><br><span class="line">						print(<span class="string">"save succcess! path:"</span>, save_path)</span><br><span class="line">						print(<span class="string">"=============================&gt;Train succcess, Time:"</span>, time.time()-start_time, <span class="string">'s!'</span>)</span><br><span class="line">						<span class="comment"># 如果正确率超过了0.9就可以提起停止训练啦</span></span><br><span class="line">						train_end_flag = <span class="keyword">True</span></span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line">			<span class="comment"># 提前停止训练            </span></span><br><span class="line">			<span class="keyword">if</span> train_end_flag:</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			<span class="comment"># 每过一个epoch，计算一个训练误差</span></span><br><span class="line">			train_cost /= BATCHES</span><br><span class="line">			<span class="comment"># 每过一个epoch，调用一下验证集测试</span></span><br><span class="line">			val_inputs, val_targets, val_seq_len = get_next_batch(BATCH_SIZE)</span><br><span class="line">			val_feed = &#123;inputs: val_inputs,	targets: val_targets, seq_len: val_seq_len&#125;</span><br><span class="line">			val_cost, vald_acc, lr, steps = session.run([cost, acc, learning_rate, global_step], feed_dict=val_feed)</span><br><span class="line">			log = <span class="string">"Epoch &#123;&#125;/&#123;&#125;, steps = &#123;&#125;, train_cost = &#123;:.3f&#125;, val_cost = &#123;:.3f&#125;, time = &#123;:.3f&#125;s, learning_rate = &#123;&#125;"</span></span><br><span class="line">			print(log.format(curr_epoch + <span class="number">1</span>, num_epochs, steps, train_cost, val_cost, time.time()-b_start_time, lr))</span><br></pre></td></tr></table></figure>
<h2 id="2-3-测试模型"><a href="#2-3-测试模型" class="headerlink" title="2.3 测试模型"></a>2.3 测试模型</h2><p><strong>对应文件：predict_test.py</strong></p>
<p>首先导入相关的包</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先导入需要的库</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> generate_verification_code <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> train_model <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>
<p>调用<code>gen_test_verification_code()</code>函数产生100张验证码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置产生测试集文件夹的名字</span></span><br><span class="line">Testing_set_dir = <span class="string">'TestingSet'</span></span><br><span class="line">obj = generateVerificationCode()</span><br><span class="line"><span class="comment"># 生成验证码</span></span><br><span class="line">obj.gen_test_verification_code(Testing_set_dir, is_random=<span class="keyword">True</span>, num=<span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>生成验证码后可以打开<code>TestingSet</code>目录查看看生成的验证码</p>
<p><img src=".\testing_set.png" width="700px" title="testing_set"></p>
<blockquote>
<p>虽然希望产生的是100张验证码，但是可能在产生的过程中会有重名的情况，这样就把之前的验证码覆盖掉了，所以最终产生的测试集数量可能会小于100</p>
</blockquote>
<p><code>gen_test_verification_code()</code>函数生成的验证码使用该验证码里面的字符命名，这样可以方便读入验证码的时候一起读入他们的<code>label</code></p>
<p>下方的代码是使用<code>opencv</code>读入刚才产生的验证码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取这个目录里的所有图片名字列表</span></span><br><span class="line">file_list = os.listdir(Testing_set_dir) <span class="comment"># 获取此路径下的所有文件的名字列表</span></span><br><span class="line"><span class="comment"># print(file_list)</span></span><br><span class="line"><span class="comment"># 将100个训练样本打包到test_x</span></span><br><span class="line">test_x = np.zeros([len(file_list), obj.height, obj.width]) <span class="comment"># 1个通道</span></span><br><span class="line">text_list = []</span><br><span class="line"><span class="keyword">for</span> i, file <span class="keyword">in</span> enumerate(file_list):</span><br><span class="line">	image = cv2.imread(Testing_set_dir + <span class="string">'/'</span> + file)</span><br><span class="line">	gray_image = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)</span><br><span class="line">	test_x[i] = gray_image</span><br><span class="line">	text = list(file)[:<span class="number">-4</span>] <span class="comment"># remove '.png'</span></span><br><span class="line">	text_list.append(text)</span><br><span class="line"><span class="comment"># [num, height, width]=&gt;[num, width, height]</span></span><br><span class="line">test_x = np.transpose(test_x, (<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>)) </span><br><span class="line">test_targets = sparse_tuple_from(text_list)</span><br><span class="line">test_seq_len = np.ones(test_x.shape[<span class="number">0</span>]) * test_x.shape[<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>跟之前产生训练集一样，需要对读入的图片的数据做相应的数据变换（<code>opencv</code>读入后的数据格式为<code>numpy</code>的<code>array</code>）</p>
<p>最后产生的数据保存在<code>test_x</code>、<code>test_targets</code>和<code>test_seq_len</code>中</p>
<ul>
<li>test_x：shape=[num, width, height]</li>
<li>test_targets：稀疏矩阵形式的label</li>
<li>test_seq_len：LSTM网络的时间序列长度，也就是每张图片的长度</li>
</ul>
<p>测试数据产生完后，接下来开始测试训练好的模型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义一些placeholder作为输入数据的入口</span></span><br><span class="line">inputs = tf.placeholder(tf.float32, [<span class="keyword">None</span>, OUTPUT_SHAPE[<span class="number">1</span>], OUTPUT_SHAPE[<span class="number">0</span>]])</span><br><span class="line"><span class="comment">#targets是标签(稀疏矩阵的形式)，因为定义ctc_loss需要的稀疏矩阵</span></span><br><span class="line">targets = tf.sparse_placeholder(tf.int32)</span><br><span class="line"><span class="comment">#1维向量 序列长度 [batch_size,]</span></span><br><span class="line"><span class="comment">#是一个长度=BATCH_SIZE=64的一维向量,每个里面都是256，表示一个batch中每一张有256条输入序列  </span></span><br><span class="line">seq_len = tf.placeholder(tf.int32, [<span class="keyword">None</span>])</span><br><span class="line"><span class="comment"># 调用前面定义好的模型，并传入值</span></span><br><span class="line">logits = RNN(inputs, seq_len)</span><br><span class="line"><span class="comment"># 解码，获得结果</span></span><br><span class="line">decoded, log_prob = tf.nn.ctc_beam_search_decoder(logits, seq_len, merge_repeated=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>
<p>定义会话开始测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> session:</span><br><span class="line">	session.run(tf.global_variables_initializer())</span><br><span class="line">	<span class="comment"># 载入模型</span></span><br><span class="line">	saver = tf.train.Saver(tf.global_variables(), max_to_keep=<span class="number">3</span>)</span><br><span class="line">	ckpt_dir = <span class="string">"./ckpt_dir"</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(ckpt_dir):</span><br><span class="line">		os.makedirs(ckpt_dir)</span><br><span class="line">	ckpt = tf.train.get_checkpoint_state(ckpt_dir)</span><br><span class="line">	<span class="keyword">if</span> ckpt <span class="keyword">and</span> ckpt.model_checkpoint_path:</span><br><span class="line">		saver.restore(session, ckpt.model_checkpoint_path)</span><br><span class="line">		print(<span class="string">"Restore succcess! path:"</span>, ckpt.model_checkpoint_path)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="comment"># 如果没有找到保存的模型参数，打印出错信息</span></span><br><span class="line">		print(<span class="string">"Error：Model not found"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 开始喂入测试数据进行预测，结果保存到pre_list列表中</span></span><br><span class="line">	test_feed = &#123;inputs: test_x, targets: test_targets, seq_len: test_seq_len&#125;</span><br><span class="line">	decoded_list = session.run(decoded[<span class="number">0</span>], test_feed)</span><br><span class="line">    <span class="comment"># 解码并开始作对比</span></span><br><span class="line">	original_list = decode_sparse_tensor(test_targets)</span><br><span class="line">	detected_list = decode_sparse_tensor(decoded_list)</span><br><span class="line">	true_numer = <span class="number">0</span></span><br><span class="line">	<span class="keyword">if</span> len(original_list) != len(detected_list):</span><br><span class="line">		print(<span class="string">"len(original_list)"</span>, len(original_list), <span class="string">"len(detected_list)"</span>, len(detected_list),</span><br><span class="line">			  <span class="string">" test and detect length desn't match"</span>)</span><br><span class="line">	print(<span class="string">"T/F: original(length) &lt;-------&gt; detectcted(length)"</span>)</span><br><span class="line">	<span class="keyword">for</span> idx, number <span class="keyword">in</span> enumerate(original_list):</span><br><span class="line">		detect_number = detected_list[idx]</span><br><span class="line">		hit = (number == detect_number)</span><br><span class="line">		print(hit, number, <span class="string">"("</span>, len(number), <span class="string">") &lt;-------&gt; "</span>, detect_number, <span class="string">"("</span>, len(detect_number), <span class="string">")"</span>)</span><br><span class="line">		<span class="keyword">if</span> hit:</span><br><span class="line">			true_numer = true_numer + <span class="number">1</span></span><br><span class="line">	Accuracy = true_numer * <span class="number">1.0</span> / len(original_list)</span><br><span class="line">	print(<span class="string">"Test Accuracy:"</span>, Accuracy)</span><br></pre></td></tr></table></figure>
<p>我的测试结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Generating.........(<span class="number">100</span>/<span class="number">100</span>)</span><br><span class="line">Test verification code generated</span><br><span class="line">Restore succcess! path: ./ckpt_dir/model.ckpt<span class="number">-1900</span></span><br><span class="line">T/F: original(length) &lt;-------&gt; detectcted(length)</span><br><span class="line">True ['8', '4'] ( 2 ) &lt;-------&gt;  ['8', '4'] ( 2 )</span><br><span class="line">True ['0', '9', '4', '3'] ( 4 ) &lt;-------&gt;  ['0', '9', '4', '3'] ( 4 )</span><br><span class="line">True ['0'] ( 1 ) &lt;-------&gt;  ['0'] ( 1 )</span><br><span class="line">True ['8', '2'] ( 2 ) &lt;-------&gt;  ['8', '2'] ( 2 )</span><br><span class="line">True ['5', '0', '6', '4', '1'] ( 5 ) &lt;-------&gt;  ['5', '0', '6', '4', '1'] ( 5 )</span><br><span class="line">...（省略）</span><br><span class="line">True ['1', '7', '8', '2', '4'] ( 5 ) &lt;-------&gt;  ['1', '7', '8', '2', '4'] ( 5 )</span><br><span class="line">True ['0', '8', '1', '4', '9'] ( 5 ) &lt;-------&gt;  ['0', '8', '1', '4', '9'] ( 5 )</span><br><span class="line">True ['1', '5'] ( 2 ) &lt;-------&gt;  ['1', '5'] ( 2 )</span><br><span class="line">Test Accuracy: <span class="number">1.0</span></span><br></pre></td></tr></table></figure>
<h2 id="2-4-遇到的问题"><a href="#2-4-遇到的问题" class="headerlink" title="2.4 遇到的问题"></a>2.4 遇到的问题</h2><p><strong>unicode编码报错：<code>NameError: name &#39;unicode&#39; is not defined</code></strong></p>
<p><img src="./UnicodeErroro.jpg" width="400px"></p>
<p><strong>错误原因：</strong>在python3中才会报此错误，所以应该是ython版本不兼容所致，python3将<code>unicode</code>改为<code>str</code>了</p>
<p><strong>解决办法：</strong>如果你使用的是python3，将<code>unicode</code>改为<code>str</code>即可解决</p>
<p><strong>参考资料：</strong></p>
<p><a href="https://www.tensorflow.org/api_docs/python/tf/nn/ctc_loss" target="_blank" rel="noopener">Tensorflow官网</a>(可能需要科学上网)</p>
<p><a href="http://ilovin.me/2017-04-23/tensorflow-lstm-ctc-input-output/" target="_blank" rel="noopener">http://ilovin.me/2017-04-23/tensorflow-lstm-ctc-input-output/</a></p>
<p><a href="https://www.jianshu.com/p/45828b18f133" target="_blank" rel="noopener">https://www.jianshu.com/p/45828b18f133</a>    </p>
<p><a href="https://github.com/jimmyleaf/ocr_tensorflow_cnn" target="_blank" rel="noopener">https://github.com/jimmyleaf/ocr_tensorflow_cnn</a></p>

      
    </div>

    
    <div>    
     
     
        <ul class="post-copyright">
          <li class="post-copyright-link">
            <strong>本文链接：</strong>
            <a href="/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/" title="LSTM+CTC识别变长验证码（人工智能第4次试验）">https://cjh.zone/2018/11/21/LSTM+CTC识别变长验证码（人工智能第4次试验）/</a>
          </li>
          <li class="post-copyright-license">
            <strong>版权声明： </strong>
            本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！
          </li>
        </ul>
      
    </div>
    
    
    

    

    
       
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>如果你觉得此页面对你有帮助，或者想资瓷我一下，欢迎点击下面打赏哦，谢谢~</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/WeChatQR.png" alt="JhChen 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/AliPayQR.png" alt="JhChen 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/科大/" rel="tag"># 科大</a>
          
            <a href="/tags/人工智能/" rel="tag"># 人工智能</a>
          
            <a href="/tags/tensorflow/" rel="tag"># tensorflow</a>
          
            <a href="/tags/实验/" rel="tag"># 实验</a>
          
            <a href="/tags/LSTM/" rel="tag"># LSTM</a>
          
            <a href="/tags/CTC/" rel="tag"># CTC</a>
          
            <a href="/tags/验证码识别/" rel="tag"># 验证码识别</a>
          
            <a href="/tags/深度学习/" rel="tag"># 深度学习</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/20/共享一些资源/" rel="next" title="共享一些资源">
                <i class="fa fa-chevron-left"></i> 共享一些资源
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/11/21/科大软院-《算法设计与分析》实验汇总-Part1/" rel="prev" title="科大软院-《算法设计与分析》实验汇总-Part1">
                科大软院-《算法设计与分析》实验汇总-Part1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/100x100.gif" alt="JhChen">
            
              <p class="site-author-name" itemprop="name">JhChen</p>
              <p class="site-description motion-element" itemprop="description">不想长大的石头</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/jianhuchen" title="GitHub &rarr; https://github.com/jianhuchen" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:cjh18@mail.ustc.edu.cn" title="E-Mail &rarr; mailto:cjh18@mail.ustc.edu.cn" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/cjh2018" title="Weibo &rarr; https://weibo.com/cjh2018" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://keyanjie.net" title="http://keyanjie.net" rel="noopener" target="_blank">柯延杰</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-实验题目"><span class="nav-number">1.</span> <span class="nav-text">1. 实验题目</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-实验过程"><span class="nav-number">2.</span> <span class="nav-text">2. 实验过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-产生验证码"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 产生验证码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-首先导入所需要的包"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1.1 首先导入所需要的包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-定义put-chinese-text类"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.1.2 定义put_chinese_text类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-定义generateVerificationCode类"><span class="nav-number">2.1.3.</span> <span class="nav-text">2.1.3 定义generateVerificationCode类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-训练模型"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 训练模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-定义一些超参数"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1 定义一些超参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-关于ctc-loss"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2 关于ctc_loss</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-训练数据集的生成"><span class="nav-number">2.2.3.</span> <span class="nav-text">2.2.3 训练数据集的生成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-4-定义LSTM网络模型"><span class="nav-number">2.2.4.</span> <span class="nav-text">2.2.4 定义LSTM网络模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-5-开始训练"><span class="nav-number">2.2.5.</span> <span class="nav-text">2.2.5 开始训练</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-测试模型"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 测试模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-遇到的问题"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 遇到的问题</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JhChen</span>

  

  
</div>









<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
<span id="busuanzi_container_site_uv">
  |  总访客数<span id="busuanzi_value_site_uv"></span>人
</span>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'YYDp5Xaws6vh3eOJM7bp6qsi-gzGzoHsz',
        appKey: 'FTmW5pj1DN6mdeaKvW8ajsIo',
        placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!\n填写正确的邮箱，这样如果有人回复您就会有邮件提醒哦~ \n此回复框MarkDown全语法支持,点击右下角Preview预览',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: false
    });
  </script>



  





  

  
  <script>
    
    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.time + 1);
            })
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "YYDp5Xaws6vh3eOJM7bp6qsi-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "YYDp5Xaws6vh3eOJM7bp6qsi-gzGzoHsz",
                'X-LC-Key': "FTmW5pj1DN6mdeaKvW8ajsIo",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  
  

  


  
  

  

  

  

  

  

  

</body>
</html>
